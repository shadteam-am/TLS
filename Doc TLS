# SMTP и защищённые порты 465 и 587

Для передачи почты по SMTP сегодня используется шифрование **TLS (Transport Layer Security)**.  
Оно решает три ключевые задачи:  

- защищает переписку от перехвата, шифруя трафик;  
- подтверждает подлинность почтового сервера;  
- предотвращает подмену или искажение данных в пути.  

Существует два способа использования TLS в SMTP — **Implicit TLS** и **STARTTLS**. Они отличаются порядком установления защищённого соединения.

---

## Режимы работы SMTP с TLS

### Порт 465 — Implicit TLS
При подключении клиент сразу начинает TLS-рукопожатие, то есть с первой секунды соединение защищено.  
Этот режим иногда называют **SMTPS**.  

- Всегда шифрованное соединение.  
- Нет риска случайной передачи данных в открытом виде.  

### Порт 587 — STARTTLS
Здесь соединение начинается как обычное SMTP.  
Клиент устанавливает контакт с сервером, после чего отправляет команду **STARTTLS**.  
Сервер переключает соединение в защищённый режим, и дальнейший обмен уже идёт по TLS.  

- Гибкость: клиент и сервер могут договориться о шифровании на лету.  
- Если сервер не поддерживает STARTTLS, возможно продолжение в открытом виде (но современные конфигурации обычно это запрещают).  

---

## Привязка режимов к портам

Исторически SMTP работал без шифрования. Для внедрения TLS пошли двумя путями:  

- для **Implicit TLS** был выделен отдельный порт 465, чтобы сразу различать защищённый канал;  
- для **STARTTLS** сохранили привычный порт 587 и добавили команду для переключения в зашифрованный режим.  

Таким образом:  

- **465** — всегда только защищённое соединение (Implicit TLS);  
- **587** — STARTTLS, с возможностью перехода из обычного SMTP в TLS.  

---

## Современные рекомендации

Сегодня основной порт для отправки почты — **587 с поддержкой STARTTLS**.  
Он официально закреплён за клиентской отправкой сообщений (submission).  
Порт 465 также используется многими почтовыми сервисами, но его применяют реже.  

---

## Сравнение Implicit TLS и STARTTLS

| Характеристика                | Порт **465** (Implicit TLS)                          | Порт **587** (STARTTLS) |
|-------------------------------|------------------------------------------------------|------------------------------------------------------------------------|
| Как устанавливается защита    | Шифрование включается сразу при подключении          | Сначала обычное SMTP, затем переход на TLS по команде STARTTLS         |
| Передача данных до шифрования | Невозможна — всё защищено с первой секунды           | Возможна, если сервер/клиент не включат STARTTLS (но обычно запрещено) |
| Назначение                    | Режим SMTPS (исторически отдельный порт для TLS)     | Основной порт для отправки почты (submission)                          |
| Гибкость                      | Только зашифрованное соединение                      | Можно согласовать шифрование «на лету»                                 |
| Современные рекомендации      | Используется, но реже                                | Рекомендуемый стандартный порт                                         |

---

## Схемы подключения

### SMTP через порт 465 (Implicit TLS)
1. Клиент подключается к порту 465  
2. Сразу начинается TLS-рукопожатие  
3. Соединение установлено (защищено)  
4. Обмен SMTP-командами  

### SMTP через порт 587 (STARTTLS)
1. Клиент подключается к порту 587  
2. Начинается обычное SMTP-соединение  
3. Клиент отправляет команду STARTTLS  
4. TLS-рукопожатие  
5. Соединение переведено в защищённый режим  
6. Обмен SMTP-командами  
